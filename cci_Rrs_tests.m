function [varargout]=cci_Rrs_tests(numTest);
% [varargout]=cci_Rrs_tests(numTest);
% (numTest==1) single spectrum case; [varargout] <- [wv_cci,Rrs_at_cci]
% (numTest==-1) mapped model-data comparison

wv_cci=[412, 443, 490, 510, 555, 670];
wv_drwn3=[400,425,450,475,500,525,550,575,600,625,650,675,700];

%% test 1: single spectrum case

if numTest==1;
    
    Rirr              = 1e-3*[23.7641,26.5037,27.9743,30.4914,28.1356,21.9385,18.6545,13.5100,5.6338,3.9272,2.9621,2.1865,1.8015];
    ttmp=Rirr/3;
    Rrs_drwn3         = (0.52*ttmp)./(1-1.7*ttmp);
    Rrs_at_cci        = interp1(wv_drwn3,Rrs_drwn3,wv_cci);
    
    %
    
    RRSB=max(Rrs_at_cci(2:3));
    RRSG=Rrs_at_cci(5);
    X = log10(RRSB./RRSG);
    
    C{1}=[0.4507    -2.6040 -1.2876 +6.5324 -5.1420];
    C{2}=[0.6588    -3.2742 +0.5860 +3.2253 -3.0903];
    C{3}=[0.3272    -2.9940 +2.7218 -1.2259 -0.5683];
    C{4}=[0.2424    -2.7423 +1.8017 +0.0015 -1.2280];
    chldD=NaN*zeros(size(C));
    for ii=1:4;
        a0=C{ii}(1); a1=C{ii}(2); a2=C{ii}(3);
        a3=C{ii}(4); a4=C{ii}(5);
        chldD(ii)=10.^(a0+a1*X+a2*X.^2+a3*X.^3+a4*X.^4);
    end;
    
    %Moore 2009 version of the Fuzzy logic classifier:
    
    M{1}=[0.0234 0.0192 0.0129 0.0075 0.0031 0.0002];
    M{2}=[0.0162 0.0141 0.0112 0.0073 0.0034 0.0002];
    M{3}=[0.0107 0.0098 0.0092 0.0070 0.0039 0.0003];
    M{4}=[0.0065 0.0064 0.0070 0.0064 0.0048 0.0006];
    M{5}=[0.0033 0.0034 0.0042 0.0042 0.0043 0.0009];
    M{6}=[0.0064 0.0074 0.0105 0.0116 0.0140 0.0041];
    M{7}=[0.0121 0.0140 0.0192 0.0204 0.0231 0.0084];
    M{8}=[0.0184 0.0230 0.0333 0.0359 0.0409 0.0137];
    
    S{1}=[...
        0.00000959 0.00000556 0.00000138 -0.00000034 -0.00000024 -0.00000003;...
        0.00000556 0.00000493 0.00000193 0.00000060 0.00000023 0.00000001;...
        0.00000138 0.00000193 0.00000282 0.00000223 0.00000119 0.00000007;...
        -0.00000034 0.00000060 0.00000223 0.00000232 0.00000119 0.00000007;...
        -0.00000024 0.00000023 0.00000119 0.00000119 0.00000071 0.00000005;...
        -0.00000003 0.00000001 0.00000007 0.00000007 0.00000005 0.00000001];
    
    S{2}=[...
        0.00000346 0.00000186 -0.00000011 -0.00000060 -0.00000062 -0.00000005;...
        0.00000186 0.00000228 0.00000086 0.00000033 -0.00000007 0.00000003;...
        -0.00000011 0.00000086 0.00000231 0.00000221 0.00000145 0.00000023;...
        -0.00000060 0.00000033 0.00000221 0.00000266 0.00000191 0.00000034;...
        -0.00000062 -0.00000007 0.00000145 0.00000191 0.00000175 0.00000041;...
        -0.00000005 0.00000003 0.00000023 0.00000034 0.00000041 0.00000021];
    
    S{3}=[...
        0.00000241 0.00000144 0.00000035 -0.00000031 -0.00000063 -0.00000006;...
        0.00000144 0.00000138 0.00000076 0.00000015 -0.00000021 -0.00000001;...
        0.00000035 0.00000076 0.00000161 0.00000156 0.00000121 0.00000016;...
        -0.00000031 0.00000015 0.00000156 0.00000227 0.00000209 0.00000031;...
        -0.00000063 -0.00000021 0.00000121 0.00000209 0.00000225 0.00000037;...
        -0.00000006 -0.00000001 0.00000016 0.00000031 0.00000037 0.00000013];
    
    S{4}=[...
        0.00000166 0.00000091 0.00000034 -0.00000009 -0.00000080 -0.00000025;...
        0.00000091 0.00000097 0.00000071 0.00000025 -0.00000041 -0.00000015;...
        0.00000034 0.00000071 0.00000118 0.00000103 0.00000072 0.00000003;...
        -0.00000009 0.00000025 0.00000103 0.00000137 0.00000162 0.00000025;...
        -0.00000080 -0.00000041 0.00000072 0.00000162 0.00000290 0.00000065;...
        -0.00000025 -0.00000015 0.00000003 0.00000025 0.00000065 0.00000050];
    
    S{5}=[...
        0.00000178 0.00000132 0.00000104 0.00000081 0.00000018 -0.00000014;...
        0.00000132 0.00000127 0.00000121 0.00000099 0.00000034 -0.00000010;...
        0.00000104 0.00000121 0.00000150 0.00000142 0.00000110 0.00000013;...
        0.00000081 0.00000099 0.00000142 0.00000158 0.00000177 0.00000042;...
        0.00000018 0.00000034 0.00000110 0.00000177 0.00000351 0.00000131;...
        -0.00000014 -0.00000010 0.00000013 0.00000042 0.00000131 0.00000081];
    
    S{6}=[...
        0.00000715 0.00000586 0.00000409 0.00000292 0.00000005 -0.00000075;...
        0.00000586 0.00000589 0.00000520 0.00000398 0.00000027 -0.00000114;...
        0.00000409 0.00000520 0.00000634 0.00000541 0.00000188 -0.00000097;...
        0.00000292 0.00000398 0.00000541 0.00000528 0.00000392 0.00000070;...
        0.00000005 0.00000027 0.00000188 0.00000392 0.00000995 0.00000657;...
        -0.00000075 -0.00000114 -0.00000097 0.00000070 0.00000657 0.00000819];
    
    S{7}=[...
        0.00002625 0.00001981 0.00001058 0.00000544 -0.00000654 -0.00001122;...
        0.00001981 0.00001745 0.00001314 0.00000822 -0.00000431 -0.00001228;...
        0.00001058 0.00001314 0.00001629 0.00001226 0.00000035 -0.00001311;...
        0.00000544 0.00000822 0.00001226 0.00001170 0.00000742 -0.00000500;...
        -0.00000654 -0.00000431 0.00000035 0.00000742 0.00002241 0.00001782;...
        -0.00001122 -0.00001228 -0.00001311 -0.00000500 0.00001782 0.00003987];
    
    S{8}=[...
        0.00001186 0.00001134 0.00001139 0.00000919 0.00000395 -0.00000186;...
        0.00001134 0.00001484 0.00002034 0.00001907 0.00001531 0.00000087;...
        0.00001139 0.00002034 0.00003467 0.00003546 0.00003555 0.00000708;...
        0.00000919 0.00001907 0.00003546 0.00003907 0.00004604 0.00001733;...
        0.00000395 0.00001531 0.00003555 0.00004604 0.00007306 0.00004953;...
        -0.00000186 0.00000087 0.00000708 0.00001733 0.00004953 0.00006542];

    Sinv={}; for ii=1:length(S); Sinv{ii}=inv(S{ii}); end;

    ttl='MooreEtAl2009';

    %Jackson 2017 version of the Fuzzy logic classifier:

    J_m=[...
        0.01871 0.01583 0.01345 0.01106 0.00914 0.00759 0.00605 0.00471 0.00353 0.00244 0.00111 0.00336 0.00642 0.00988;...
        0.01344 0.01182 0.01049 0.00908 0.00765 0.00652 0.00555 0.00465 0.00375 0.00285 0.00166 0.00390 0.00746 0.01245;...
        0.00734 0.00691 0.00657 0.00617 0.00566 0.00520 0.00475 0.00421 0.00368 0.00307 0.00217 0.00556 0.01032 0.01835;...
        0.00361 0.00351 0.00348 0.00348 0.00340 0.00331 0.00324 0.00304 0.00291 0.00257 0.00200 0.00615 0.01099 0.01988;...
        0.00153 0.00150 0.00155 0.00163 0.00168 0.00172 0.00180 0.00179 0.00192 0.00184 0.00168 0.00746 0.01250 0.02286;...
        0.00017 0.00015 0.00016 0.00018 0.00019 0.00021 0.00023 0.00024 0.00028 0.00029 0.00030 0.00215 0.00443 0.00729];
    
    J_s=[...
        0.00441 0.00080 0.00077 0.00076 0.00068 0.00056 0.00059 0.00053 0.00052 0.00057 0.00055 0.00193 0.00369 0.00248;...
        0.00110 0.00059 0.00058 0.00060 0.00051 0.00044 0.00043 0.00038 0.00040 0.00044 0.00056 0.00175 0.00301 0.00278;...
        0.00145 0.00089 0.00103 0.00107 0.00081 0.00063 0.00065 0.00051 0.00050 0.00041 0.00054 0.00182 0.00291 0.00425;...
        0.00177 0.00114 0.00134 0.00142 0.00103 0.00082 0.00086 0.00067 0.00067 0.00050 0.00047 0.00166 0.00247 0.00451;...
        0.00211 0.00133 0.00158 0.00168 0.00115 0.00088 0.00095 0.00070 0.00090 0.00086 0.00062 0.00227 0.00341 0.00616;...
        0.00087 0.00054 0.00063 0.00069 0.00040 0.00028 0.00030 0.00021 0.00030 0.00033 0.00033 0.00206 0.00455 0.00583];

    if 0;
        ncload v2.0_class_cov_inv_and_means.nc
        M={}; S={}; Sinv={};
        for ii=1:14;
            Sinv{ii}=squeeze(inverse_covariance(ii,1:6,1:6));
            S{ii}=inv(Sinv{ii});
            M{ii}=cluster_means(:,ii)';
        end;
        ttl='JaksonEtAl2017';
    end;

    %plot fuzzy logic mean
    figure; 
    for ii=1:length(S); plot(wv_cci,M{ii},'LineWidth',2); hold on; end;
    grid on; set(gca,'FontSize',12); xlabel('nm'); ylabel('Rrs'); title(ttl);
    
    %compute fuzzy logic classifier:

    fuzzyMmbr=NaN*zeros(length(S),1);
    for ii=1:length(S);
        Xi=(Rrs_at_cci-M{ii})';
        Zi=Xi'*Sinv{ii}*Xi;
        fuzzyMmbr(ii)=1-chi2cdf(Zi,6);
    end;
    
    %
    
    varargout={wv_cci,Rrs_at_cci,chldD,fuzzyMmbr};
    
    %starting point (Rirr, 13 bands):
    %1e-3 *
    % 23.7641
    % 26.5037
    % 27.9743
    % 30.4914
    % 28.1356
    % 21.9385
    % 18.6545
    % 13.5100
    %  5.6338
    %  3.9272
    %  2.9621
    %  2.1865
    %  1.8015
    
    %After conversion:
    %1e-3 *
    %  4.1753
    %  4.6640
    %  4.9270
    %  5.3781
    %  4.9558
    %  3.8505
    %  3.2680
    %  2.3598
    %  0.9796
    %  0.6822
    %  0.5143
    %  0.3795
    %  0.3126
    
    %After interpolation:
    %1e-3 *
    %  4.4099
    %  4.8533
    %  5.1247
    %  4.5137
    %  3.0864
    %  0.4064
    
end;

%% test 2: visual comparison between maps

if numTest==-1;
    
    gcmfaces_global; if isempty(mygrid); error('please load llc90 grid'); end;
    
    dir0=[pwd '/201805-CBIOMES-climatology/nctiles/'];
    list0=dir([dir0 'IrradianceReflectance/']);
    ii = find(strncmp({list0(:).name},'Rirr',4));
    
    fld=NaN*repmat(mygrid.RAC,[1 1 12 13]);
    for jj=1:13;
        tmp=list0(ii(jj)).name;
        fld(:,:,:,jj)=read_nctiles([dir0 'IrradianceReflectance/' tmp '/' tmp]);
    end;
    
    %
    
    ttmp=fld/3;
    fld=(0.52*ttmp)./(1-1.7*ttmp);
    
    tmp1=interp1(wv_drwn3,[1:13],wv_cci);
    jj=floor(tmp1); ww=tmp1-jj;
    
    wv_drwn3(jj).*(1-ww)+wv_drwn3(jj+1).*ww
    
    FLD=NaN*repmat(mygrid.RAC,[1 1 12 6]);
    for kk=1:6;
        tmp0=fld(:,:,:,jj(kk)); tmp1=fld(:,:,:,jj(kk)+1);
        FLD(:,:,:,kk)=tmp0.*(1-ww(kk))+tmp1.*ww(kk);
    end;
    
    %
    
    cc_from_BB=[25 17 8.2 8.2 8.0 2.3]*1e-3;
    
    for kk=1:6;
        figureL;
        tmp=FLD(:,:,1,kk); cc=cc_from_BB(kk);
        m_map_gcmfaces(tmp,1.2,{'myCaxis',cc*[0:0.1:1]},{'myCmap','inferno'});
        title(['201805-CBIOMES-climatology: annual mean rrs at ' num2str(wv_cci(kk))]);
        %     print(gcf,'-dpng',['~/Desktop/rrs_' num2str(wv_cci(kk)) '_annualmean.png']);
    end;
    
end;
